<!doctype html>
<html>
    <head>
        <meta http-equiv="Content-Language" chartset="utf-8" content="en" />

        <title>HN batch analyzer</title>
        <style>
            :root {
                color-scheme: light;
                --bg: #f6f6ef;
                --paper: #ffffff;
                --paper-2: #fff9f2;
                --text: #1c1b1a;
                --muted: #6e6b67;
                --accent: #ff6600;
                --accent-2: #f0b35a;
                --border: #e4e0d7;
                --danger: #c2410c;
                --success: #15803d;
                --shadow: 0 12px 30px rgba(41, 29, 20, 0.12);
            }
            * {
                box-sizing: border-box;
            }
            body {
                margin: 0;
                font-family: "Newsreader", "Iowan Old Style", "Palatino Linotype", "Book Antiqua", serif;
                background: linear-gradient(180deg, #fff6ea 0%, #f6f6ef 22%, #f6f6ef 100%);
                color: var(--text);
                min-height: 100vh;
            }
            main {
                max-width: 920px;
                margin: 0 auto;
                padding: 36px 20px 80px;
                display: flex;
                flex-direction: column;
                gap: 22px;
            }
            h1 {
                font-size: 32px;
                margin: 0;
                letter-spacing: -0.02em;
            }
            h2 {
                margin: 0 0 10px;
                font-size: 20px;
                letter-spacing: -0.01em;
                color: var(--accent);
            }
            p {
                margin: 0;
                color: var(--muted);
                font-family: "Inter", "Segoe UI", sans-serif;
                font-size: 14px;
            }
            .card {
                background: var(--paper);
                border: 1px solid var(--border);
                border-radius: 10px;
                padding: 18px 20px;
                box-shadow: var(--shadow);
            }
            .card.hero {
                border-left: 6px solid var(--accent);
                background: linear-gradient(135deg, #fff, #fff6ea);
            }
            .actions {
                display: flex;
                flex-wrap: wrap;
                gap: 12px;
                align-items: center;
            }
            button {
                border: 1px solid #de5a00;
                border-radius: 6px;
                padding: 10px 16px;
                font-size: 13px;
                font-weight: 700;
                cursor: pointer;
                color: #fff;
                background: linear-gradient(180deg, #ff7a1a, #ff6600);
                text-transform: uppercase;
                letter-spacing: 0.04em;
                transition: transform 0.2s ease, box-shadow 0.2s ease;
            }
            button.secondary {
                background: linear-gradient(180deg, #f2bf6f, #f0b35a);
                border-color: #e09b3b;
                color: #3a2a1c;
            }
            button:active {
                transform: translateY(1px);
            }
            button:disabled {
                opacity: 0.6;
                cursor: not-allowed;
            }
            .status-pill {
                display: inline-flex;
                align-items: center;
                gap: 8px;
                padding: 6px 10px;
                border-radius: 999px;
                background: var(--paper-2);
                color: var(--muted);
                font-size: 12px;
                border: 1px dashed var(--border);
            }
            .dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: var(--muted);
                animation: pulse 1.4s ease-in-out infinite;
            }
            .dot.success {
                background: var(--success);
            }
            .dot.error {
                background: var(--danger);
            }
            @keyframes pulse {
                0%,
                100% {
                    transform: scale(0.8);
                    opacity: 0.6;
                }
                50% {
                    transform: scale(1);
                    opacity: 1;
                }
            }
            details {
                border: 1px solid var(--border);
                border-radius: 8px;
                padding: 10px 12px;
                background: #fffaf4;
            }
            summary {
                cursor: pointer;
                font-weight: 700;
                color: var(--text);
                font-family: "Inter", "Segoe UI", sans-serif;
                text-transform: uppercase;
                letter-spacing: 0.03em;
                font-size: 12px;
            }
            .meta {
                font-size: 12px;
                color: var(--muted);
                margin-top: 6px;
                font-family: "Inter", "Segoe UI", sans-serif;
            }
            .list {
                display: flex;
                flex-direction: column;
                gap: 10px;
                margin-top: 12px;
            }
            .list-item {
                padding: 10px 12px;
                border-radius: 6px;
                background: var(--paper-2);
                border: 1px solid #f0e3d2;
            }
            .list-item h4 {
                margin: 0 0 6px;
                font-size: 16px;
            }
            .list-item a {
                color: var(--accent);
                text-decoration: none;
                font-size: 12px;
                font-family: "Inter", "Segoe UI", sans-serif;
            }
            textarea {
                width: 100%;
                min-height: 140px;
                background: #fffdf9;
                border: 1px solid var(--border);
                border-radius: 8px;
                padding: 12px;
                color: var(--text);
                font-family: "Inter", "Segoe UI", sans-serif;
                font-size: 14px;
            }
            .error {
                color: var(--danger);
                font-weight: 700;
                font-family: "Inter", "Segoe UI", sans-serif;
            }
            .overview {
                white-space: pre-wrap;
                font-size: 15px;
                line-height: 1.55;
            }
            .divider {
                height: 3px;
                width: 100%;
                background: repeating-linear-gradient(
                    90deg,
                    var(--accent),
                    var(--accent) 12px,
                    transparent 12px,
                    transparent 22px
                );
                border-radius: 999px;
                margin: 8px 0 2px;
            }
        </style>
    </head>
    <body>
        <main>
            <header class="card hero">
                <h1>HN batch analyzer</h1>
                <p>Fetch the latest Hacker News stories, then generate an overview tailored to your bio.</p>
                <div class="divider"></div>
            </header>

            <section class="card">
                <h2>1) Fetch the latest batch</h2>
                <div class="actions">
                    <button id="fetch">Fetch new batch</button>
                    <span class="status-pill" id="fetchStatus">
                        <span class="dot" id="fetchDot"></span>
                        <span id="fetchText">Idle</span>
                    </span>
                </div>
                <div class="meta" id="jobMeta">(no job running)</div>
            </section>

            <section class="card">
                <details id="batchDetails" open>
                    <summary>Latest batch</summary>
                    <div class="meta" id="batchMeta">(no batch yet)</div>
                    <div class="list" id="batchOut"></div>
                </details>
            </section>

            <section class="card">
                <h2>2) Add your bio</h2>
                <textarea id="bio" placeholder="Paste your bio here..."></textarea>
                <div class="actions" style="margin-top: 12px">
                    <button id="analyze" class="secondary">Run analysis</button>
                    <span class="status-pill" id="analyzeStatus">
                        <span class="dot" id="analyzeDot"></span>
                        <span id="analyzeText">Idle</span>
                    </span>
                </div>
                <div id="error" class="error" style="margin-top: 10px"></div>
            </section>

            <section class="card">
                <details id="summariesDetails" open>
                    <summary>Summaries</summary>
                    <div class="list" id="summariesOut"></div>
                </details>
            </section>

            <section class="card">
                <h2>Overview article</h2>
                <div class="overview" id="overviewOut">(no overview yet)</div>
            </section>
        </main>

        <script>
            const fetchBtn = document.getElementById("fetch");
            const analyzeBtn = document.getElementById("analyze");
            const jobMeta = document.getElementById("jobMeta");
            const batchOut = document.getElementById("batchOut");
            const summariesOut = document.getElementById("summariesOut");
            const overviewOut = document.getElementById("overviewOut");
            const errorPanel = document.getElementById("error");
            const bio = document.getElementById("bio");
            const fetchStatus = document.getElementById("fetchStatus");
            const fetchText = document.getElementById("fetchText");
            const fetchDot = document.getElementById("fetchDot");
            const analyzeStatus = document.getElementById("analyzeStatus");
            const analyzeText = document.getElementById("analyzeText");
            const analyzeDot = document.getElementById("analyzeDot");
            const batchMeta = document.getElementById("batchMeta");

            const sleep = (ms) => new Promise((r) => setTimeout(r, ms));
            const BIO_STORAGE_KEY = "hn_bio";

            const setStatus = (kind, text, state) => {
                const dot = kind === "fetch" ? fetchDot : analyzeDot;
                const label = kind === "fetch" ? fetchText : analyzeText;
                label.textContent = text;
                dot.classList.remove("success", "error");
                if (state) {
                    dot.classList.add(state);
                }
            };

            const getBioHash = async (text) => {
                if (!text) return null;
                const data = new TextEncoder().encode(text);
                const hashBuffer = await crypto.subtle.digest("SHA-256", data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map((b) => b.toString(16).padStart(2, "0")).join("");
            };

            const renderBatch = (data) => {
                batchMeta.textContent = `Batch #${data.batch_number} · ${data.created_at}`;

                batchOut.replaceChildren();
                (data.stories || []).forEach((story) => {
                    const item = document.createElement("div");
                    item.className = "list-item";
                    const title = document.createElement("h4");
                    title.textContent = `${story.rank}. ${story.title}`;
                    const link = document.createElement("a");
                    link.href = story.url;
                    link.textContent = story.url;
                    link.target = "_blank";
                    item.append(title, link);
                    batchOut.append(item);
                });

                summariesOut.replaceChildren();
                (data.summaries || []).forEach((summary) => {
                    const item = document.createElement("div");
                    item.className = "list-item";
                    const title = document.createElement("h4");
                    const story = data.stories.find((s) => s.id === summary.story_id);
                    title.textContent = story ? story.title : `Story ${summary.story_id}`;
                    const text = document.createElement("p");
                    text.textContent = summary.summary_text;
                    item.append(title, text);
                    summariesOut.append(item);
                });

                overviewOut.textContent = data.overview
                    ? data.overview.article_text
                    : "(no overview yet)";
            };

            const fetchLatestBatch = async () => {
                const bioHash = await getBioHash(bio.value.trim());
                const url = bioHash
                    ? `/api/batches/latest/?bio_hash=${encodeURIComponent(bioHash)}`
                    : "/api/batches/latest/";
                const resp = await fetch(url);
                if (resp.status === 404) {
                    batchMeta.textContent = "(no batch yet)";
                    batchOut.textContent = "";
                    summariesOut.textContent = "";
                    overviewOut.textContent = "(no overview yet)";
                    return;
                }
                const data = await resp.json();
                renderBatch(data);
            };

            const pollJob = async (jobId) => {
                while (true) {
                    const resp = await fetch(`/api/jobs/${jobId}/`);
                    const data = await resp.json();
                    jobMeta.textContent = `${data.message || "Working"} · ${data.progress_current}/${data.progress_total}`;
                    if (data.status === "COMPLETE") {
                        return data;
                    }
                    if (data.status === "ERROR") {
                        throw new Error(data.error || "Job failed");
                    }
                    await sleep(1500);
                }
            };

            fetchBtn.addEventListener("click", async () => {
                fetchBtn.disabled = true;
                setStatus("fetch", "Fetching…", null);
                errorPanel.textContent = "";
                try {
                    const resp = await fetch("/api/jobs/fetch-batch/", {
                        method: "POST",
                    });
                    if (!resp.ok) {
                        const text = await resp.text();
                        throw new Error(text || `Request failed: ${resp.status}`);
                    }
                    const data = await resp.json();
                    await pollJob(data.job_id);
                    await fetchLatestBatch();
                    setStatus("fetch", "Done", "success");
                } catch (err) {
                    errorPanel.textContent = err.message;
                    setStatus("fetch", "Error", "error");
                } finally {
                    fetchBtn.disabled = false;
                }
            });

            analyzeBtn.addEventListener("click", async () => {
                analyzeBtn.disabled = true;
                setStatus("analyze", "Analyzing…", null);
                errorPanel.textContent = "";
                try {
                    const payload = { bio: bio.value };
                    const resp = await fetch("/api/jobs/analyze/", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload),
                    });
                    if (!resp.ok) {
                        const text = await resp.text();
                        throw new Error(text || `Request failed: ${resp.status}`);
                    }
                    const data = await resp.json();
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    await pollJob(data.job_id);
                    await fetchLatestBatch();
                    setStatus("analyze", "Done", "success");
                } catch (err) {
                    errorPanel.textContent = err.message;
                    setStatus("analyze", "Error", "error");
                } finally {
                    analyzeBtn.disabled = false;
                }
            });

            const savedBio = localStorage.getItem(BIO_STORAGE_KEY);
            if (savedBio) {
                bio.value = savedBio;
            }
            bio.addEventListener("input", () => {
                localStorage.setItem(BIO_STORAGE_KEY, bio.value);
            });

            fetchLatestBatch().catch(() => {});
        </script>
    </body>
</html>
