<!doctype html>
<html>
    <head>
        <meta http-equiv="Content-Language" chartset="utf-8" content="en" />

        <title>lgraph-demo</title>
        <style>
            body {
                font-family:
                    system-ui,
                    -apple-system,
                    sans-serif;
                padding: 24px;
            }
            button {
                padding: 10px 14px;
                cursor: pointer;
            }
            pre {
                padding: 12px;
                background: #f6f6f6;
                border-radius: 8px;
            }
            .row {
                margin-top: 12px;
                display: flex;
                gap: 8px;
                align-items: center;
            }
            #spinner {
                display: none;
            }
        </style>
    </head>
    <body>
        <h1>HN batch analyzer</h1>

        <div class="row">
            <button id="fetch">Fetch new batch</button>
            <button id="analyze">Run analysis</button>
            <span id="spinner">Workingâ€¦</span>
        </div>

        <div class="row" style="align-items: flex-start">
            <textarea
                id="bio"
                placeholder="Paste your bio here..."
                style="padding: 8px; width: 520px; height: 120px"
            ></textarea>
            <div>
                <label style="display: block; font-size: 12px; opacity: 0.7"
                    >Optional batch number</label
                >
                <input
                    id="batchNumber"
                    type="number"
                    min="1"
                    style="padding: 8px; width: 140px"
                />
            </div>
        </div>

        <div id="error" style="color: #b00020; margin-top: 12px"></div>

        <h3>Job status</h3>
        <pre id="jobStatus">(no job running)</pre>

        <h3>Latest batch</h3>
        <pre id="batchOut">(no batch yet)</pre>

        <h3>Overview</h3>
        <pre id="overviewOut">(no overview yet)</pre>

        <h3>Summaries</h3>
        <pre id="summariesOut">(no summaries yet)</pre>

        <script>
            const fetchBtn = document.getElementById("fetch");
            const analyzeBtn = document.getElementById("analyze");
            const spinner = document.getElementById("spinner");
            const jobStatus = document.getElementById("jobStatus");
            const batchOut = document.getElementById("batchOut");
            const summariesOut = document.getElementById("summariesOut");
            const overviewOut = document.getElementById("overviewOut");
            const errorPanel = document.getElementById("error");
            const bio = document.getElementById("bio");
            const batchNumber = document.getElementById("batchNumber");

            const sleep = (ms) => new Promise((r) => setTimeout(r, ms));
            const BIO_STORAGE_KEY = "hn_bio";

            const getBioHash = async (text) => {
                if (!text) return null;
                const data = new TextEncoder().encode(text);
                const hashBuffer = await crypto.subtle.digest("SHA-256", data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map((b) => b.toString(16).padStart(2, "0")).join("");
            };

            const renderBatch = (data) => {
                batchOut.textContent = JSON.stringify(
                    {
                        batch_number: data.batch_number,
                        created_at: data.created_at,
                        stories: data.stories,
                    },
                    null,
                    2,
                );
                summariesOut.textContent = JSON.stringify(
                    data.summaries || [],
                    null,
                    2,
                );
                overviewOut.textContent = data.overview
                    ? data.overview.article_text
                    : "(no overview yet)";
            };

            const fetchLatestBatch = async () => {
                const bioHash = await getBioHash(bio.value.trim());
                const url = bioHash
                    ? `/api/batches/latest/?bio_hash=${encodeURIComponent(bioHash)}`
                    : "/api/batches/latest/";
                const resp = await fetch(url);
                if (resp.status === 404) {
                    batchOut.textContent = "(no batch yet)";
                    summariesOut.textContent = "(no summaries yet)";
                    overviewOut.textContent = "(no overview yet)";
                    return;
                }
                const data = await resp.json();
                renderBatch(data);
            };

            const pollJob = async (jobId) => {
                while (true) {
                    const resp = await fetch(`/api/jobs/${jobId}/`);
                    const data = await resp.json();
                    jobStatus.textContent = JSON.stringify(data, null, 2);
                    if (data.status === "COMPLETE") {
                        return data;
                    }
                    if (data.status === "ERROR") {
                        throw new Error(data.error || "Job failed");
                    }
                    await sleep(1500);
                }
            };

            fetchBtn.addEventListener("click", async () => {
                spinner.style.display = "inline";
                errorPanel.textContent = "";
                try {
                    const resp = await fetch("/api/jobs/fetch-batch/", {
                        method: "POST",
                    });
                    if (!resp.ok) {
                        const text = await resp.text();
                        throw new Error(text || `Request failed: ${resp.status}`);
                    }
                    const data = await resp.json();
                    await pollJob(data.job_id);
                    await fetchLatestBatch();
                } catch (err) {
                    errorPanel.textContent = err.message;
                } finally {
                    spinner.style.display = "none";
                }
            });

            analyzeBtn.addEventListener("click", async () => {
                spinner.style.display = "inline";
                errorPanel.textContent = "";
                try {
                    const payload = { bio: bio.value };
                    if (batchNumber.value) {
                        payload.batch_number = Number(batchNumber.value);
                    }
                    const resp = await fetch("/api/jobs/analyze/", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload),
                    });
                    if (!resp.ok) {
                        const text = await resp.text();
                        throw new Error(text || `Request failed: ${resp.status}`);
                    }
                    const data = await resp.json();
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    await pollJob(data.job_id);
                    await fetchLatestBatch();
                } catch (err) {
                    errorPanel.textContent = err.message;
                } finally {
                    spinner.style.display = "none";
                }
            });

            const savedBio = localStorage.getItem(BIO_STORAGE_KEY);
            if (savedBio) {
                bio.value = savedBio;
            }
            bio.addEventListener("input", () => {
                localStorage.setItem(BIO_STORAGE_KEY, bio.value);
            });

            fetchLatestBatch().catch(() => {});
        </script>
    </body>
</html>
